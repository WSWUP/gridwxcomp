

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="Python" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="Python" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>gridwxcomp.spatial &mdash; gridwxcomp 0.0.68 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/copybutton.js"></script>
        <script type="text/javascript" src="../../_static/custom.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@1/dist/clipboard.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> gridwxcomp
          

          
          </a>

          
            
            
              <div class="version">
                0.0.68
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../getting_started.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_started.html#quick-start-from-command-line">Quick start from command line</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#command-line-interface">Command Line Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#gridwxcomp">gridwxcomp</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#gridwxcomp-prep-input">gridwxcomp prep-input</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#gridwxcomp-download-gridmet-ee">gridwxcomp download-gridmet-ee</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#gridwxcomp-spatial">gridwxcomp spatial</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#gridwxcomp-plot">gridwxcomp plot</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#python-functions-classes-and-modules">Python functions, classes, and modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#prep-input">prep_input</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#download-gridmet-ee">download_gridmet_ee</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#module-gridwxcomp.calc_bias_ratios">calc_bias_ratios</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#module-gridwxcomp.spatial">spatial</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#module-gridwxcomp.plot">plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#interpgdal">InterpGdal</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api.html#module-gridwxcomp.util">util</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Change Log</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#version-0-0-6">Version 0.0.6</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#version-0-0-5">Version 0.0.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#version-0-0-4">Version 0.0.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#version-0-0-3">Version 0.0.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#version-0-0-2">Version 0.0.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#version-0-0-1">Version 0.0.1</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">gridwxcomp</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>gridwxcomp.spatial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for gridwxcomp.spatial</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Perform multiple workflows needed to estimate the spatial surface of monthly </span>
<span class="sd">and annual bias ratios for multiple climatic variables. The input file is first </span>
<span class="sd">created by :mod:`gridwxcomp.calc_bias_ratios`.</span>

<span class="sd">Attributes:</span>
<span class="sd">    CELL_SIZE (float): constant gridMET cell size in decimal degrees,</span>
<span class="sd">        value = 0.041666666666666664.</span>

<span class="sd">Note:</span>
<span class="sd">    All spatial files, i.e. vector and raster files, utilize the</span>
<span class="sd">    *ESRI Shapefile* file or GeoTiff format. </span>
<span class="sd">    </span>
<span class="sd">Todo:</span>
<span class="sd">    * logging </span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">ceil</span><span class="p">,</span> <span class="nb">pow</span><span class="p">,</span> <span class="n">sqrt</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="k">import</span> <span class="n">move</span>

<span class="kn">import</span> <span class="nn">fiona</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">Rbf</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="k">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">mapping</span>
<span class="kn">from</span> <span class="nn">fiona</span> <span class="k">import</span> <span class="n">collection</span>
<span class="kn">from</span> <span class="nn">fiona.crs</span> <span class="k">import</span> <span class="n">from_epsg</span>
<span class="kn">from</span> <span class="nn">osgeo</span> <span class="k">import</span> <span class="n">gdal</span><span class="p">,</span> <span class="n">osr</span><span class="p">,</span> <span class="n">ogr</span>
<span class="kn">from</span> <span class="nn">rasterstats</span> <span class="k">import</span> <span class="n">zonal_stats</span>

<span class="c1"># allows for CL script usage if gridwxcomp not installed</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.plot</span> <span class="k">import</span> <span class="n">station_bar_plot</span>
    <span class="kn">from</span> <span class="nn">.util</span> <span class="k">import</span> <span class="n">get_gridmet_meta_csv</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">plot</span> <span class="k">import</span> <span class="n">station_bar_plot</span>
    <span class="kn">from</span> <span class="nn">util</span> <span class="k">import</span> <span class="n">get_gridmet_meta_csv</span>

<span class="c1"># constant gridmet resolution in decimal degrees</span>
<span class="n">CELL_SIZE</span> <span class="o">=</span> <span class="mf">0.041666666666666664</span>

<span class="n">OPJ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>
   
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">input_file_path</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
         <span class="n">function</span><span class="o">=</span><span class="s1">&#39;invdist&#39;</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zonal_stats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
         <span class="n">res_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gridmet_meta_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create point shapefile of monthly mean bias ratios from comprehensive</span>
<span class="sd">    CSV file created by :mod:`gridwxcomp.calc_bias_ratios`. Build fishnet grid </span>
<span class="sd">    around the climate stations that matches the gridMET dataset. Perform </span>
<span class="sd">    spatial interpolation to estimate 2-dimensional surface of bias ratios and </span>
<span class="sd">    extract interpolated values to gridMET cells. </span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        input_file_path (str): path to [var]_summary_comp CSV file containing </span>
<span class="sd">            monthly bias ratios, lat, long, and other data. Shapefile </span>
<span class="sd">            &quot;[var]_summary_pts.shp&quot; is saved to parent directory of </span>
<span class="sd">            ``input_file_path`` under a subdirectory named &quot;spatial&quot;.</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">        layer (str or list): default &#39;all&#39;. Name of variable(s) in ``in_path``</span>
<span class="sd">            to conduct 2-D interpolation. e.g. &#39;Annual_mean&#39;.</span>
<span class="sd">        out (str): default None. Subdirectory to save GeoTIFF rasters.</span>
<span class="sd">        gridmet_meta_path (str): default None. Path to metadata CSV file </span>
<span class="sd">            that contains all gridMET cell info. By default it is looked</span>
<span class="sd">            for in the package installation directory or current directory</span>
<span class="sd">            as &quot;gridmet_cell_data.csv&quot;.</span>
<span class="sd">        buffer (int): number of gridMET cells to expand the rectangular extent</span>
<span class="sd">            of the subgrid fishnet (default=25). </span>
<span class="sd">        scale_factor (float, int): scaling factor to apply to original</span>
<span class="sd">            gridMET fishnet to create resampling fishnet. For example,</span>
<span class="sd">            if scale_factor = 0.1, the resolution will be one tenth of </span>
<span class="sd">            the original girdMET resolution resulting in a 400 m resolution.</span>
<span class="sd">        function (str): default &#39;invdist&#39;. Interpolation method, gdal </span>
<span class="sd">            methods include </span>
<span class="sd">            * &#39;invdist&#39; </span>
<span class="sd">            * &#39;indistnn&#39; </span>
<span class="sd">            * &#39;linear&#39; </span>
<span class="sd">            * &#39;average&#39;</span>
<span class="sd">            * &#39;nearest&#39;</span>
<span class="sd">            see `gdal_grid &lt;https://www.gdal.org/gdal_grid.html&gt;`_.</span>
<span class="sd">            Radial basis functions, see :class:`scipy.interpolate.Rbf`, </span>
<span class="sd">            include</span>
<span class="sd">            * &#39;multiquadric&#39;</span>
<span class="sd">            * &#39;inverse&#39;</span>
<span class="sd">            * &#39;gaussian&#39;</span>
<span class="sd">            * &#39;linear_rbf&#39;</span>
<span class="sd">            * &#39;cubic&#39;</span>
<span class="sd">            * &#39;quintic&#39;</span>
<span class="sd">            * &#39;thin_plate&#39;</span>
<span class="sd">        smooth (float): default 0. Smooth parameter for Rbf functions.</span>
<span class="sd">        params (dict, str, or None): default None. Parameters for interpolation</span>
<span class="sd">            using gdal, see defaults in :class:`gridwxcomp.InterpGdal`.</span>
<span class="sd">        overwrite (bool): default False. If True overwrite the grid </span>
<span class="sd">            shapefile that already exists.</span>
<span class="sd">        zonal_stats (bool): default True. Calculate zonal means of interpolated</span>
<span class="sd">            surface to gridMET cells in fishnet and save to a CSV file. </span>
<span class="sd">            The CSV file will be saved to the same directory as the interpolated</span>
<span class="sd">            raster file(s).</span>
<span class="sd">        res_plot (bool): default True. Make bar plot for residual (error)</span>
<span class="sd">            between interpolated and station value for ``layer``.</span>
<span class="sd">        options (str or None): default None. Extra command line arguments</span>
<span class="sd">            for gdal interpolation.</span>
<span class="sd">        gridmet_meta_path (str): default None. Path to metadata CSV file </span>
<span class="sd">            that contains all gridMET cells for the contiguous United </span>
<span class="sd">            States. If None it is looked for at the install directory of </span>
<span class="sd">            gridwxcomp (i.e. with pip install) or within the current directory</span>
<span class="sd">            as &quot;gridmet_cell_data.csv&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    Examples:</span>
<span class="sd">        From the command line,</span>

<span class="sd">        .. code-block:: sh</span>

<span class="sd">            $ python spatial.py -i monthly_ratios/etr_mm_summary_comp_all_yrs.csv </span>

<span class="sd">        This will produce a subdirectory under &quot;monthly_ratios&quot; named</span>
<span class="sd">        &quot;spatial&quot; where a point shapefile will be saved as </span>
<span class="sd">        &quot;etr_mm_summary_pts.shp&quot;. It will also create a spatially referenced </span>
<span class="sd">        fishnet of gridMET cells (at &quot;monthly_ratios/spatial/grid.shp&quot;) with </span>
<span class="sd">        a buffer of 25 gridMET cells added around the encompassed climate </span>
<span class="sd">        stations. Next a 2-dimensional surface is interpolated from the point </span>
<span class="sd">        data of each mean bias ratio in etr_mm_summary_comp_all_yrs.csv which </span>
<span class="sd">        includes monthly, growing season, summer, and annual means using the </span>
<span class="sd">        inverse distance weighting method. The interpolated rasters are saved </span>
<span class="sd">        to::</span>
<span class="sd">        </span>
<span class="sd">            &#39;monthly_ratios/spatial/etr_mm_inverse_dist_400m/&#39;&#39; </span>
<span class="sd">            </span>
<span class="sd">        with file names of the form::</span>
<span class="sd">        </span>
<span class="sd">            [time_period].tiff</span>
<span class="sd">            </span>
<span class="sd">        where [time_period] refers to the bias ratio time aggregate e.g. </span>
<span class="sd">        Apr_mean or Annual_mean. Resolution in meters of the spatially </span>
<span class="sd">        interpolated raster, gridMET variable name, and interpolation function </span>
<span class="sd">        are saved to the output directory which can have additional parent </span>
<span class="sd">        subdirectories if the ``out`` argument is given. Zonal mean statistics </span>
<span class="sd">        are calculated for gridMET cells in the fishnet that was created. They </span>
<span class="sd">        are saved to::</span>
<span class="sd">        </span>
<span class="sd">            &#39;monthly_ratios/spatial/etr_mm_inverse_dist_400m/gridMET_stats.csv&#39;</span>
<span class="sd">            </span>
<span class="sd">        The contents of the CSV file will look something like::</span>
<span class="sd">        </span>
<span class="sd">            ==========  ========  ========  ========  ========</span>
<span class="sd">            GRIDMET_ID  Apr_mean  Aug_mean  Dec_mean  ...</span>
<span class="sd">            ==========  ========  ========  ========  ========</span>
<span class="sd">            515902      1.028707  0.856440  1.058291  ...</span>
<span class="sd">            514516      1.035543  0.862066  1.065963  ...</span>
<span class="sd">            ...         ...       ...       ...       ...</span>
<span class="sd">            ==========  ========  ========  ========  ========</span>
<span class="sd">        </span>
<span class="sd">        Alternatively, to use a smaller buffer zone on the fishnet grid </span>
<span class="sd">        used for interpolation if, for example, extrapolation is not needed, </span>
<span class="sd">        use the ``[-b, --buffer]`` option</span>

<span class="sd">        .. code-block:: sh</span>

<span class="sd">            $ python spatial.py -i monthly_ratios/etr_mm_summary_comp_all_yrs.csv -b 5</span>

<span class="sd">        Or, if we wanted to interpolate to a 200 m resolution </span>
<span class="sd">        (i.e. scale_factor = 0.05, 0.05 x 4 km = 200 m) using the &#39;inverse&#39;</span>
<span class="sd">        radial basis function,</span>
<span class="sd">        </span>
<span class="sd">        .. code-block:: sh</span>

<span class="sd">            $ python spatial.py -i monthly_ratios/etr_mm_summary_comp_all_yrs.csv -s 0.05 -f &#39;inverse&#39;        </span>

<span class="sd">        To calculate zonal means for a different climate variable, e.g. </span>
<span class="sd">        observed ET (&quot;eto_mm&quot;), as opposed to reference ET (default) use the </span>
<span class="sd">        corresponding input file</span>
<span class="sd">        </span>
<span class="sd">        .. code-block:: sh</span>

<span class="sd">            $ python spatial.py -i monthly_ratios/eto_mm_summary_comp_all_yrs.csv -s 0.05 -f &#39;inverse&#39;                </span>

<span class="sd">        In this case the final zonal statistics of zonal mean bias ratios </span>
<span class="sd">        will be saved to::</span>
<span class="sd">        </span>
<span class="sd">            &#39;monthly_ratios/spatial/etr_mm_inverse_200m/gridMET_stats.csv&#39;</span>

<span class="sd">        To run interpolation of a single layer that is not part of the default</span>
<span class="sd">        mean layers, e.g. the coefficient of variation of the growing season</span>
<span class="sd">        bias ratio, assign the ``[-l, --layer]`` option,</span>
<span class="sd">        </span>
<span class="sd">        .. code-block:: sh</span>

<span class="sd">            $ python spatial.py -i monthly_ratios/etr_mm_summary_comp_all_yrs.csv -l April_to_oct_cv</span>
<span class="sd">            </span>
<span class="sd">        Also see examples of :func:`make_points_file`, :func:`make_grid`, </span>
<span class="sd">        :func:`interpolate`, and the :class:`gridwxcomp.InterGdal` class.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># build fishnet for interpolation</span>
    <span class="n">make_grid</span><span class="p">(</span><span class="n">input_file_path</span><span class="p">,</span> 
              <span class="n">gridmet_meta_path</span><span class="o">=</span><span class="n">gridmet_meta_path</span><span class="p">,</span> 
              <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span> 
              <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
    
    <span class="c1"># run spatial interpolation depending on options</span>
    <span class="n">interpolate</span><span class="p">(</span>
        <span class="n">input_file_path</span><span class="p">,</span> 
        <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> 
        <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span>
        <span class="n">scale_factor</span><span class="o">=</span><span class="n">scale_factor</span><span class="p">,</span> 
        <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">,</span> 
        <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span>
        <span class="n">zonal_stats</span><span class="o">=</span><span class="n">zonal_stats</span><span class="p">,</span>
        <span class="n">res_plot</span><span class="o">=</span><span class="n">res_plot</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
        <span class="n">gridmet_meta_path</span><span class="o">=</span><span class="n">gridmet_meta_path</span><span class="p">)</span> 

<div class="viewcode-block" id="make_points_file"><a class="viewcode-back" href="../../api.html#gridwxcomp.spatial.make_points_file">[docs]</a><span class="k">def</span> <span class="nf">make_points_file</span><span class="p">(</span><span class="n">in_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create vector shapefile of points with monthly mean bias ratios </span>
<span class="sd">    for climate stations using all stations found in a comprehensive</span>
<span class="sd">    CSV file created by :mod:`gridwxcomp.calc_bias_ratios`.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        in_path (str): path to [var]_summary_comp.CSV file containing </span>
<span class="sd">            monthly bias ratios, lat, long, and other data. Shapefile </span>
<span class="sd">            &quot;[var]_summary_pts.shp&quot; is saved to parent directory of </span>
<span class="sd">            ``in_path`` under &quot;spatial&quot; subdirectory.</span>
<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    </span>
<span class="sd">    Example:</span>
<span class="sd">        Create shapefile containing point data for all climate stations</span>
<span class="sd">        in input summary file created by :mod:`gridwxcomp.calc_bias_ratios`</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; from gridwxcomp import spatial</span>
<span class="sd">        &gt;&gt;&gt; # path to comprehensive summary CSV</span>
<span class="sd">        &gt;&gt;&gt; summary_file = &#39;monthly_ratios/etr_mm_summary_comp_all_yrs.csv&#39;</span>
<span class="sd">        &gt;&gt;&gt; spatial.make_points_file(summary_file)</span>
<span class="sd">        </span>
<span class="sd">        The result is the file &quot;etr_mm_summary_pts.shp&quot; being saved to </span>
<span class="sd">        a subdirectory created in the directory containing ``in_path``</span>
<span class="sd">        named &quot;spatial&quot;, i.e.::</span>

<span class="sd">            &quot;monthly_ratios/spatial/etr_mm_summary_pts.shp&quot;. </span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: if input summary CSV file is not found.</span>
<span class="sd">        </span>
<span class="sd">    Note:</span>
<span class="sd">        :func:`make_points_file` will overwrite any existing point</span>
<span class="sd">        shapefile of the same climate variable. </span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">in_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;Input summary CSV file: &#39;</span><span class="o">+</span>\
                                <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">was not found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">in_path</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Mapping point data for climate stations in: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">in_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="p">)</span>
    <span class="n">in_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;STATION_ID&#39;</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">999</span><span class="p">])</span>
    <span class="c1"># save shapefile to &quot;spatial&quot; subdirectory of in_path</span>
    <span class="n">path_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># get variable name from input file prefix</span>
    <span class="n">var_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_summ&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">OPJ</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="s1">&#39;spatial&#39;</span><span class="p">)</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="n">OPJ</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{v}</span><span class="s1">_summary_pts.shp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="n">var_name</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span>            
        <span class="s1">&#39;Creating point shapefile of station bias ratios, saving to: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">out_file</span><span class="p">),</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="p">)</span>
    <span class="c1"># create output directory if does not exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">out_dir</span><span class="p">,</span> 
            <span class="s1">&#39; does not exist, creating directory.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>

    <span class="n">crs</span> <span class="o">=</span> <span class="n">from_epsg</span><span class="p">(</span><span class="mi">4326</span><span class="p">)</span> <span class="c1"># WGS 84 projection</span>
    <span class="c1"># attributes of shapefile</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span> 
        <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="s1">&#39;Point&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span> 
            <span class="s1">&#39;Jan&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Feb&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Mar&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Apr&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;May&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Jun&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Jul&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Aug&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Sep&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Oct&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Nov&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Dec&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;summer&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;growseason&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;annual&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Jan_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Feb_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Mar_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Apr_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;May_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Jun_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Jul_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Aug_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Sep_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Oct_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Nov_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Dec_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;summer_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;grow_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;annual_cnt&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Jan_std&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Feb_std&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Mar_std&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Apr_std&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;May_std&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Jun_std&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Jul_std&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Aug_std&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Sep_std&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Oct_std&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Nov_std&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Dec_std&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;summer_std&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;grow_std&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;annual_std&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Jan_cv&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Feb_cv&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Mar_cv&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Apr_cv&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;May_cv&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Jun_cv&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Jul_cv&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Aug_cv&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Sep_cv&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Oct_cv&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Nov_cv&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Dec_cv&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;summer_cv&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;grow_cv&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;annual_cv&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="s1">&#39;STATION_ID&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>
            <span class="s1">&#39;GRIDMET_ID&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span>
        <span class="p">}}</span>

    <span class="c1"># create shapefile from points, overwrite if exists</span>
    <span class="k">with</span> <span class="n">collection</span><span class="p">(</span>
        <span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> 
        <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;ESRI Shapefile&#39;</span><span class="p">,</span> 
        <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> 
        <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
        <span class="c1"># loop through stations and add point data to shapefile</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">in_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;Saving point data for station: &#39;</span><span class="p">,</span>
                <span class="n">index</span><span class="p">,</span> 
            <span class="p">)</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">STATION_LON</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">STATION_LAT</span><span class="p">))</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
                <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;Jan&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Jan_mean&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Feb&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Feb_mean&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Mar&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Mar_mean&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Apr&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Apr_mean&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;May&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;May_mean&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Jun&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Jun_mean&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Jul&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Jul_mean&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Aug&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Aug_mean&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Sep&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Sep_mean&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Oct&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Oct_mean&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Nov&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Nov_mean&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Dec&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Dec_mean&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;summer&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;summer_mean&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;growseason&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;growseason_mean&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;annual&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;annual_mean&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Jan_cnt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Jan_count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Feb_cnt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Feb_count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Mar_cnt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Mar_count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Apr_cnt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Apr_count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;May_cnt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;May_count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Jun_cnt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Jun_count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Jul_cnt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Jul_count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Aug_cnt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Aug_count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Sep_cnt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Sep_count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Oct_cnt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Oct_count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Nov_cnt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Nov_count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Dec_cnt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Dec_count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;summer_cnt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;summer_count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;grow_cnt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;growseason_count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;annual_cnt&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;annual_count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Jan_std&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Jan_stdev&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Feb_std&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Feb_stdev&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Mar_std&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Mar_stdev&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Apr_std&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Apr_stdev&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;May_std&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;May_stdev&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Jun_std&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Jun_stdev&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Jul_std&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Jul_stdev&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Aug_std&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Aug_stdev&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Sep_std&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Sep_stdev&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Oct_std&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Oct_stdev&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Nov_std&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Nov_stdev&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Dec_std&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Dec_stdev&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;summer_std&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;summer_stdev&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;grow_std&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;growseason_stdev&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;annual_std&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;annual_stdev&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Jan_cv&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Jan_cv&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Feb_cv&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Feb_cv&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Mar_cv&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Mar_cv&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Apr_cv&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Apr_cv&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;May_cv&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;May_cv&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Jun_cv&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Jun_cv&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Jul_cv&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Jul_cv&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Aug_cv&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Aug_cv&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Sep_cv&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Sep_cv&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Oct_cv&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Oct_cv&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Nov_cv&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Nov_cv&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Dec_cv&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Dec_cv&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;summer_cv&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;summer_cv&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;grow_cv&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;growseason_cv&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;annual_cv&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;annual_cv&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;STATION_ID&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
                    <span class="s1">&#39;GRIDMET_ID&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GRIDMET_ID&#39;</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="get_subgrid_bounds"><a class="viewcode-back" href="../../api.html#gridwxcomp.spatial.get_subgrid_bounds">[docs]</a><span class="k">def</span> <span class="nf">get_subgrid_bounds</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">buffer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate bounding box for spatial interpolation grid from </span>
<span class="sd">    comprehensive summary CSV file containing monthly bias ratios</span>
<span class="sd">    and station locations. </span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        in_path (str): path to comprehensive summary file containing</span>
<span class="sd">            monthly bias ratios, created by :func:`gridwxcomp.calc_bias_ratios`.</span>
<span class="sd">        buffer (int): number of gridMET cells to expand the rectangular extent</span>
<span class="sd">            of the subgrid fishnet. </span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        bounds (tuple): tuple with coordinates in decimal degrees that</span>
<span class="sd">            define the outer bounds of the subgrid fishnet in the format</span>
<span class="sd">            (min long, max long, min lat, max lat)</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: if input summary CSV file is not found.</span>

<span class="sd">    Note:</span>
<span class="sd">        By expanding the grid to a larger area encompassing the climate </span>
<span class="sd">        stations of interest :func:`interpolate` can be used to extrapolate</span>
<span class="sd">        passed the bounds of the outer station locations.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">in_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;Input summary CSV file given&#39;</span><span class="o">+</span>\
                                <span class="s1">&#39; was invalid or not found&#39;</span><span class="p">)</span>

    <span class="n">in_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span>
    
    <span class="c1"># values are centroids of gridmet, get corners</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">in_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;LON&#39;</span><span class="p">)[</span><span class="s1">&#39;LON&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">lon_min</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">CELL_SIZE</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">lon_max</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">CELL_SIZE</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">lats</span> <span class="o">=</span> <span class="n">in_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;LAT&#39;</span><span class="p">)[</span><span class="s1">&#39;LAT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">lat_min</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">CELL_SIZE</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">lat_max</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">CELL_SIZE</span> <span class="o">/</span> <span class="mi">2</span>
    
    <span class="c1"># expand bounding extent based on buffer cells</span>
    <span class="n">lon_min</span> <span class="o">-=</span> <span class="n">CELL_SIZE</span><span class="o">*</span><span class="n">buffer</span>
    <span class="n">lat_min</span> <span class="o">-=</span> <span class="n">CELL_SIZE</span><span class="o">*</span><span class="n">buffer</span>
    <span class="n">lon_max</span> <span class="o">+=</span> <span class="n">CELL_SIZE</span><span class="o">*</span><span class="n">buffer</span>
    <span class="n">lat_max</span> <span class="o">+=</span> <span class="n">CELL_SIZE</span><span class="o">*</span><span class="n">buffer</span>    
    
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span>
    
    <span class="k">return</span> <span class="n">bounds</span></div>

<div class="viewcode-block" id="make_grid"><a class="viewcode-back" href="../../api.html#gridwxcomp.spatial.make_grid">[docs]</a><span class="k">def</span> <span class="nf">make_grid</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
        <span class="n">gridmet_meta_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make fishnet grid (vector file of polygon geometry) for </span>
<span class="sd">    select gridMET cells based on bounding coordinates. </span>
<span class="sd">    </span>
<span class="sd">    Add gridMET ID values to each cell based on their centroid </span>
<span class="sd">    lookup in ``gridwxcomp/gridmet_cell_data.csv``. Assigns the </span>
<span class="sd">    WGS84 reference coordinate system. The grid is later used to </span>
<span class="sd">    spatially interpolate point data. Modified from the </span>
<span class="sd">    `Python GDAL/OGR Cookbook &lt;https://pcjericks.github.io/py-gdalogr-cookbook/vector_layers.html#create-fishnet-grid&gt;`_.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        in_path (str): path to [var]_summary_comp_[years].csv file containing monthly</span>
<span class="sd">            bias ratios, lat, long, and other data. Created by </span>
<span class="sd">            :func:`gridwxcomp.calc_bias_ratios`.</span>
<span class="sd">    </span>
<span class="sd">    Keyword Arguments:</span>
<span class="sd">        bounds (tuple or None): default None. Tuple of bounding coordinates </span>
<span class="sd">            in the following order (min long, max long, min lat, max lat) </span>
<span class="sd">            which need to be in decimal degrees. Need to align with gridMET</span>
<span class="sd">            resolution outer corners. If None, get extent from centoid</span>
<span class="sd">            locations of climate stations in ``in_path`` summary CSV. </span>
<span class="sd">        buffer (int): default 25. Number of gridMET cells to expand </span>
<span class="sd">            the rectangular extent of the subgrid fishnet and interpolated</span>
<span class="sd">            output raster.</span>
<span class="sd">        overwrite (bool): default False. If True overwrite the grid </span>
<span class="sd">            shapefile at ``out_path`` if it already exists.</span>
<span class="sd">        gridmet_meta_path (str): default None. Path to metadata CSV file </span>
<span class="sd">            that contains all gridMET cells for the contiguous United </span>
<span class="sd">            States. If None it is looked for at the install directory of </span>
<span class="sd">            gridwxcomp (i.e. with pip install) or within the current directory</span>
<span class="sd">            as &quot;gridmet_cell_data.csv&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">        </span>
<span class="sd">    Examples:</span>
<span class="sd">        Build a fishnet uniform grid that matches gridMET cells around</span>
<span class="sd">        climate stations found in ``in_path`` summary CSV file with a </span>
<span class="sd">        25 cell buffer. </span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; from gridwxcomp import spatial</span>
<span class="sd">        &gt;&gt;&gt; # assign input paths</span>
<span class="sd">        &gt;&gt;&gt; summary_file = &#39;monthly_ratios/etr_mm_summary_comp_all_yrs.csv&#39;</span>
<span class="sd">        &gt;&gt;&gt; # make fishnet of gridMET cells for interpolation</span>
<span class="sd">        &gt;&gt;&gt; spatial.make_grid(summary_file)</span>
<span class="sd">            </span>
<span class="sd">        The file will be saved as &quot;grid.shp&quot; to a newly created subdirectory</span>
<span class="sd">        &quot;spatial&quot; in the same directory as the input summary CSV file. i.e.::</span>
<span class="sd">        </span>
<span class="sd">            monthly_ratios/</span>
<span class="sd">             etr_mm_summary_all_yrs.csv</span>
<span class="sd">             etr_mm_summary_comp_all_yrs.csv</span>
<span class="sd">             spatial/</span>
<span class="sd">                 grid.cpg</span>
<span class="sd">                 grid.dbf</span>
<span class="sd">                 grid.prj</span>
<span class="sd">                 grid.shp</span>
<span class="sd">                 grid.shx</span>
<span class="sd">        </span>
<span class="sd">        To use a smaller buffer to the extent of the grid assign the </span>
<span class="sd">        ``buffer`` keyword argument</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; spatial.make_grid(summary_file, buffer=5)        </span>
<span class="sd">            </span>
<span class="sd">        If the grid file already exists the default action is to not </span>
<span class="sd">        overwrite. To overwrite an existing grid if, for example, you </span>
<span class="sd">        are working with a new set of climate stations as input, then </span>
<span class="sd">        set the ``overwrite`` keyword argument to True. </span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; spatial.make_grid(summary_file, overwrite=True, buffer=5)       </span>
<span class="sd">            </span>
<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: if input summary CSV file is not found. </span>
<span class="sd">        </span>
<span class="sd">    Note:</span>
<span class="sd">        If cells in the fishnet grid lie outside of the gridMET master </span>
<span class="sd">        fishnet for the contiguous U.S., the GRIDMET_ID will be assigned </span>
<span class="sd">        to -999. </span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">in_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;Input summary CSV file given&#39;</span><span class="o">+</span>\
                                <span class="s1">&#39; was invalid or not found&#39;</span><span class="p">)</span>
    <span class="c1"># save grid to &quot;spatial&quot; subdirectory of in_path</span>
    <span class="n">path_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">OPJ</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="s1">&#39;spatial&#39;</span><span class="p">)</span>
    <span class="n">out_path</span> <span class="o">=</span> <span class="n">OPJ</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;grid.shp&#39;</span><span class="p">)</span>
    
    <span class="c1"># skip building grid if already exists</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Fishnet grid already exists at: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">out_path</span><span class="p">,</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">not overwriting.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span>
    <span class="c1"># print message if overwriting existing grid</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Overwriting fishnet grid at: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">out_path</span><span class="p">,</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="p">)</span>
    <span class="c1"># create output directory if does not exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">out_dir</span><span class="p">),</span> 
            <span class="s1">&#39; does not exist, creating directory.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
        
    <span class="c1"># get grid extent based on station locations in CSV</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bounds</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">get_subgrid_bounds</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span>    
    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">bounds</span>
    <span class="c1"># read path and make parent directories if they don&#39;t exist    </span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path_root</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path_root</span><span class="p">),</span> 
            <span class="s1">&#39; does not exist, creating directory.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_root</span><span class="p">)</span>
        
    <span class="nb">print</span><span class="p">(</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Creating fishnet grid for subset of gridMET cells, </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Southwest corner (lat, long): </span><span class="si">{:9.4f}</span><span class="s1">, </span><span class="si">{:9.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">xmin</span><span class="p">),</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Northeast corner (lat, long): </span><span class="si">{:9.4f}</span><span class="s1">, </span><span class="si">{:9.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">xmax</span><span class="p">),</span>
    <span class="p">)</span>
    
    <span class="c1"># get n rows</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">((</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="n">CELL_SIZE</span><span class="p">)</span>
    <span class="c1"># get n columns</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">((</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">CELL_SIZE</span><span class="p">)</span>

    <span class="c1"># start grid cell envelope</span>
    <span class="n">ringXleftOrigin</span> <span class="o">=</span> <span class="n">xmin</span>
    <span class="n">ringXrightOrigin</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="n">CELL_SIZE</span>
    <span class="n">ringYtopOrigin</span> <span class="o">=</span> <span class="n">ymax</span>
    <span class="n">ringYbottomOrigin</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">CELL_SIZE</span>
    
    <span class="c1"># add spatial reference system WGS 84, add argument to CreateLayer</span>
    <span class="c1">#dest_srs = ogr.osr.SpatialReference()</span>
    <span class="c1">#dest_srs.ImportFromEPSG(4326)</span>
    
    <span class="c1"># create output file</span>
    <span class="n">outDriver</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s1">&#39;ESRI Shapefile&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
    <span class="n">outDataSource</span> <span class="o">=</span> <span class="n">outDriver</span><span class="o">.</span><span class="n">CreateDataSource</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
    <span class="n">outLayer</span> <span class="o">=</span> <span class="n">outDataSource</span><span class="o">.</span><span class="n">CreateLayer</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span><span class="n">geom_type</span><span class="o">=</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbPolygon</span> <span class="p">)</span>
    <span class="n">featureDefn</span> <span class="o">=</span> <span class="n">outLayer</span><span class="o">.</span><span class="n">GetLayerDefn</span><span class="p">()</span>

    <span class="c1"># create grid cells</span>
    <span class="n">countcols</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">countcols</span> <span class="o">&lt;</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">countcols</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># reset envelope for rows</span>
        <span class="n">ringYtop</span> <span class="o">=</span> <span class="n">ringYtopOrigin</span>
        <span class="n">ringYbottom</span> <span class="o">=</span> <span class="n">ringYbottomOrigin</span>
        <span class="n">countrows</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="n">countrows</span> <span class="o">&lt;</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">countrows</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">ring</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbLinearRing</span><span class="p">)</span>
            <span class="n">ring</span><span class="o">.</span><span class="n">AddPoint</span><span class="p">(</span><span class="n">ringXleftOrigin</span><span class="p">,</span> <span class="n">ringYtop</span><span class="p">)</span>
            <span class="n">ring</span><span class="o">.</span><span class="n">AddPoint</span><span class="p">(</span><span class="n">ringXrightOrigin</span><span class="p">,</span> <span class="n">ringYtop</span><span class="p">)</span>
            <span class="n">ring</span><span class="o">.</span><span class="n">AddPoint</span><span class="p">(</span><span class="n">ringXrightOrigin</span><span class="p">,</span> <span class="n">ringYbottom</span><span class="p">)</span>
            <span class="n">ring</span><span class="o">.</span><span class="n">AddPoint</span><span class="p">(</span><span class="n">ringXleftOrigin</span><span class="p">,</span> <span class="n">ringYbottom</span><span class="p">)</span>
            <span class="n">ring</span><span class="o">.</span><span class="n">AddPoint</span><span class="p">(</span><span class="n">ringXleftOrigin</span><span class="p">,</span> <span class="n">ringYtop</span><span class="p">)</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbPolygon</span><span class="p">)</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">AddGeometry</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>

            <span class="c1"># add new geom to layer</span>
            <span class="n">outFeature</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">featureDefn</span><span class="p">)</span>
            <span class="n">outFeature</span><span class="o">.</span><span class="n">SetGeometry</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
            <span class="n">outLayer</span><span class="o">.</span><span class="n">CreateFeature</span><span class="p">(</span><span class="n">outFeature</span><span class="p">)</span>
            <span class="n">outFeature</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># new envelope for next poly</span>
            <span class="n">ringYtop</span> <span class="o">=</span> <span class="n">ringYtop</span> <span class="o">-</span> <span class="n">CELL_SIZE</span>
            <span class="n">ringYbottom</span> <span class="o">=</span> <span class="n">ringYbottom</span> <span class="o">-</span> <span class="n">CELL_SIZE</span>

        <span class="c1"># new envelope for next poly</span>
        <span class="n">ringXleftOrigin</span> <span class="o">=</span> <span class="n">ringXleftOrigin</span> <span class="o">+</span> <span class="n">CELL_SIZE</span>
        <span class="n">ringXrightOrigin</span> <span class="o">=</span> <span class="n">ringXrightOrigin</span> <span class="o">+</span> <span class="n">CELL_SIZE</span>

    <span class="c1"># Save and close DataSources</span>
    <span class="n">outDataSource</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="nb">print</span><span class="p">(</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Fishnet shapefile successfully saved to: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">out_path</span><span class="p">),</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="p">)</span>
    <span class="c1"># reopen grid and assign gridMET attribute and coord. ref.</span>
    <span class="n">_update_subgrid</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">gridmet_meta_path</span><span class="o">=</span><span class="n">gridmet_meta_path</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">get_cell_ID</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">cell_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function that calculates the gridMET ID for gridMET cells using</span>
<span class="sd">    the coordinates of a cell in the fishnet grid. Uses the</span>
<span class="sd">    :class:`Fiona.geometry.Polygon` object to calculate centroids for</span>
<span class="sd">    gridMET cells, then lookup gridMET ID from gridmet_cells_data.csv</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        coords (list): list of coordinates that constitute a polygon for a </span>
<span class="sd">            gridMET cell. Coordinates must be acceptable as arguments to</span>
<span class="sd">            :class:`fiona.geometry.Polygon`.</span>
<span class="sd">        cell_data (:obj:`pandas.DataFrame`): pandas dataframe of the </span>
<span class="sd">            gridMET metadata CSV file &quot;gridmet_cell_data.csv&quot;.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        gridmet_id (int): gridMET ID value for gridMET cell that is defined</span>
<span class="sd">            by the bounding polygon defined by ``coords``.</span>
<span class="sd">            </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
    <span class="n">lon_c</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">CELL_SIZE</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">lat_c</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">CELL_SIZE</span> <span class="o">/</span> <span class="mi">2</span>
    
    <span class="c1"># use centroid of cell and centroid coords in cell_data</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">cell_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">cell_data</span><span class="o">.</span><span class="n">LON</span><span class="p">,</span> <span class="n">lon_c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">cell_data</span><span class="o">.</span><span class="n">LAT</span><span class="p">,</span> <span class="n">lat_c</span><span class="p">))</span>
            <span class="p">]</span>
    
    <span class="c1"># if cell falls outside of master gridMET fishnet assign -999 id</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">GRIDMET_ID</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">gridmet_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">GRIDMET_ID</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;Cell centroid (lat, long): </span><span class="si">{:9.4f}</span><span class="s1">, </span><span class="si">{:9.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lat_c</span><span class="p">,</span> <span class="n">lon_c</span><span class="p">),</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">falls outside of the gridMET dataset, &#39;</span><span class="p">,</span>
            <span class="s1">&#39;assigning GRIDMET_ID attribute -999&#39;</span>
        <span class="p">)</span>
        <span class="n">gridmet_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
    
    <span class="k">return</span> <span class="n">gridmet_id</span>

<span class="k">def</span> <span class="nf">_update_subgrid</span><span class="p">(</span><span class="n">grid_path</span><span class="p">,</span> <span class="n">gridmet_meta_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to assign gridMET ID values and EPSG WGS 84 </span>
<span class="sd">    projection to fishnet grid.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        grid_path (str): path to fishnet grid shapefile for subset of</span>
<span class="sd">            gridMET cells which contain climate stations.</span>
<span class="sd">            </span>
<span class="sd">    Keyword Arguments:</span>
<span class="sd">        gridmet_meta_path (str): default None. Path to metadata CSV file </span>
<span class="sd">            that contains all gridMET cells for the contiguous United </span>
<span class="sd">            States. If None it is looked for at the install directory of </span>
<span class="sd">            gridwxcomp (i.e. with pip install) or within the current directory</span>
<span class="sd">            as &quot;gridmet_cell_data.csv&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: if ``grid_path`` or ``gridmet_meta_path`` </span>
<span class="sd">        are not found. If ``gridmet_meta_path`` is not passed as a </span>
<span class="sd">        command line argument and is not found in the gridwxcomp install</span>
<span class="sd">        directory and it is not in the current working directory</span>
<span class="sd">        and named &quot;gridmet_cell_data.csv&quot;.    </span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">grid_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;The file path for the gridMET fishnet &#39;</span>\
                               <span class="o">+</span><span class="s1">&#39;was invalid or does not exist. &#39;</span><span class="p">)</span>
    <span class="c1"># look for pacakged gridmet_cell_data.csv if path not given</span>
    <span class="n">gridmet_meta_path</span> <span class="o">=</span> <span class="n">get_gridmet_meta_csv</span><span class="p">(</span>
            <span class="n">gridmet_meta_path</span><span class="o">=</span><span class="n">gridmet_meta_path</span><span class="p">)</span>

    <span class="n">tmp_out</span> <span class="o">=</span> <span class="n">grid_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.shp&#39;</span><span class="p">,</span> <span class="s1">&#39;_tmp.shp&#39;</span><span class="p">)</span>

    <span class="c1"># load gridMET metadata file for looking up gridMET IDs</span>
    <span class="n">gridmet_meta_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">gridmet_meta_path</span><span class="p">)</span>
    <span class="c1"># WGS 84 projection</span>
    <span class="n">crs</span> <span class="o">=</span> <span class="n">from_epsg</span><span class="p">(</span><span class="mi">4326</span><span class="p">)</span> 

    <span class="c1"># overwrite fishnet grid with updated GRIDMET_ID field</span>
    <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">grid_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;Adding gridMET IDs to fishnet grid, saving to: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">grid_path</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        
        <span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">source</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;Looking up and assigning values for &#39;</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> 
            <span class="s1">&#39; gridcells.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="p">)</span>        
        
        <span class="c1"># Copy the source schema and add GRIDMET_ID property.</span>
        <span class="n">sink_schema</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">schema</span>
        <span class="n">sink_schema</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;GRIDMET_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;int&#39;</span>
        <span class="c1"># overwrite file add spatial reference</span>
        <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
                <span class="n">tmp_out</span><span class="p">,</span> 
                <span class="s1">&#39;w&#39;</span><span class="p">,</span> 
                <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> 
                <span class="n">driver</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">driver</span><span class="p">,</span> 
                <span class="n">schema</span><span class="o">=</span><span class="n">sink_schema</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">sink</span><span class="p">:</span>
            <span class="c1"># add GRIDMET_ID feature to outfile</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">gridmet_id</span> <span class="o">=</span> <span class="n">get_cell_ID</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">gridmet_meta_df</span><span class="p">)</span>
                <span class="n">feature</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;GRIDMET_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gridmet_id</span>
                <span class="n">sink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
    <span class="c1"># cannot open same file and write to it on Windows, overwrite temp</span>
    <span class="n">root_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">grid_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;_tmp&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">move</span><span class="p">(</span><span class="n">OPJ</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">OPJ</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_tmp&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s1">&#39;Completed assigning gridMET IDs to fishnet. </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="p">)</span>

    
<div class="viewcode-block" id="interpolate"><a class="viewcode-back" href="../../api.html#gridwxcomp.spatial.interpolate">[docs]</a><span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
                <span class="n">function</span><span class="o">=</span><span class="s1">&#39;invdist&#39;</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                <span class="n">buffer</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">zonal_stats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">res_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                <span class="n">gridmet_meta_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use various methods to interpolate a 2-dimensional surface of</span>
<span class="sd">    calculated bias ratios or other statistics for station/gridMET</span>
<span class="sd">    pairs found in input comprehensive summary CSV. </span>
<span class="sd">    </span>
<span class="sd">    Options allow for modifying down- or up-scaling the resolution of the </span>
<span class="sd">    resampling grid and to select from multiple interpolation methods.</span>
<span class="sd">    Interploated surfaces are saved as GeoTIFF rasters. Zonal statistics </span>
<span class="sd">    using :func:`gridmet_zonal_stats` are also extracted to gridMET cells in</span>
<span class="sd">    the fishnet grid built first by :func:`make_grid`. </span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        in_path (str): path to [var]_summary_comp_[years].csv file containing </span>
<span class="sd">            monthly bias ratios, lat, long, and other data. Created by </span>
<span class="sd">            :func:`gridwxcomp.calc_bias_ratios`.</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">        layer (str or list): default &#39;all&#39;. Name of variable(s) in ``in_path``</span>
<span class="sd">            to conduct 2-D interpolation. e.g. &#39;Annual_mean&#39;.</span>
<span class="sd">        out (str): default None. Subdirectory to save GeoTIFF raster(s).</span>
<span class="sd">        scale_factor (float, int): default 0.1. Scaling factor to apply to </span>
<span class="sd">            original gridMET fishnet to create resampling resolution. If </span>
<span class="sd">            scale_factor = 0.1, the resolution will be one tenth gridMET </span>
<span class="sd">            resolution or 400 m.</span>
<span class="sd">        function (str): default &#39;invdist&#39;. Interpolation method, gdal </span>
<span class="sd">            methods include: &#39;invdist&#39;, &#39;indistnn&#39;, &#39;linear&#39;, &#39;average&#39;,</span>
<span class="sd">            and &#39;nearest&#39; see `gdal_grid &lt;https://www.gdal.org/gdal_grid.html&gt;`_.</span>
<span class="sd">            Radial basis functions, see :class:`scipy.interpolate.Rbf`, </span>
<span class="sd">            include: &#39;multiquadric&#39;, &#39;inverse&#39;, &#39;gaussian&#39;, &#39;linear_rbf&#39;,</span>
<span class="sd">            &#39;cubic&#39;, &#39;quintic&#39;, and &#39;thin_plate&#39;.</span>
<span class="sd">        smooth (float): default 0. Smooth parameter for Rbf functions.</span>
<span class="sd">        params (dict, str, or None): default None. Parameters for interpolation</span>
<span class="sd">            using gdal, see defaults in :class:`gridwxcomp.InterpGdal`.</span>
<span class="sd">        bounds (tuple or None): default None. Tuple of bounding coordinates </span>
<span class="sd">            in the following order (min long, max long, min lat, max lat) </span>
<span class="sd">            which need to be in decimal degrees. Need to align with gridMET</span>
<span class="sd">            resolution outer corners. If None, get extent from centoid</span>
<span class="sd">            locations of climate stations in ``in_path`` summary CSV. </span>
<span class="sd">        buffer (int): default 25. Number of gridMET cells to expand </span>
<span class="sd">            the rectangular extent of the subgrid fishnet and interpolated</span>
<span class="sd">            output raster.</span>
<span class="sd">        zonal_stats (bool): default True. Calculate zonal means of interpolated</span>
<span class="sd">            surface to gridMET cells in fishnet and save to a CSV file. </span>
<span class="sd">            The CSV file will be saved to the same directory as the interpolated</span>
<span class="sd">            raster file(s).            </span>
<span class="sd">        res_plot (bool): default True. Make bar plot for residual (error)</span>
<span class="sd">            between interpolated and station value for ``layer``.</span>
<span class="sd">        options (str or None): default None. Extra command line arguments</span>
<span class="sd">            for gdal interpolation.</span>
<span class="sd">        gridmet_meta_path (str or None): default None. Path to metadata CSV </span>
<span class="sd">            file that contains all gridMET cells for the contiguous United </span>
<span class="sd">            States. If None it is looked for at the install directory of </span>
<span class="sd">            gridwxcomp (e.g. after pip install gridwxcomp) or within the </span>
<span class="sd">            current directory as &#39;gridmet_cell_data.csv&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">        </span>
<span class="sd">    Examples:</span>
<span class="sd">        Let&#39;s say we wanted to interpolate the &quot;Annual_mean&quot; bias </span>
<span class="sd">        ratio in an input CSV first created by :func:`gridwxcomp.calc_bias_ratios` and a fishnet</span>
<span class="sd">        grid was first created by :func:`make_grid`. This example uses the </span>
<span class="sd">        &quot;invdist&quot; method (default) to interpolate to a 400 m resolution </span>
<span class="sd">        surface. The result is a GeoTIFF raster that has an extent that </span>
<span class="sd">        encompasses station locations in the input file plus an additional </span>
<span class="sd">        optional buffer of outer gridMET cells. Additionally, point residuals </span>
<span class="sd">        of bias ratios are added to CSV and newly created point shapefiles, </span>
<span class="sd">        zonal (gridMET cell) means are also extracted and stored in a CSV.</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; from gridwxcomp import spatial</span>
<span class="sd">        &gt;&gt;&gt; summary_file = &#39;monthly_ratios/etr_mm_summary_comp_all_yrs.csv&#39;</span>
<span class="sd">        &gt;&gt;&gt; buffer = 10</span>
<span class="sd">        &gt;&gt;&gt; layer = &#39;annual_mean&#39;</span>
<span class="sd">        &gt;&gt;&gt; params = {&#39;power&#39;:1, &#39;smooth&#39;:20}</span>
<span class="sd">        &gt;&gt;&gt; out_dir = &#39;s20_p1&#39; # optional subdir name for saving rasters</span>
<span class="sd">        &gt;&gt;&gt; interpolate(summary_file, layer=layer, out=out_dir, </span>
<span class="sd">        &gt;&gt;&gt;     scale_factor=0.1, params=params, buffer=buffer)</span>

<span class="sd">        The resulting file structure that is created by the above command is::</span>

<span class="sd">            monthly_ratios/</span>
<span class="sd">             etr_mm_summary_all_yrs.csv</span>
<span class="sd">             etr_mm_summary_comp_all_yrs.csv</span>
<span class="sd">             spatial/</span>
<span class="sd">                 etr_mm_invdist_400m/</span>
<span class="sd">                  s20_p1/</span>
<span class="sd">                      annual_mean.tiff</span>
<span class="sd">                      annual_mean.vrt</span>
<span class="sd">                      etr_mm_summary_comp_all_yrs.csv</span>
<span class="sd">                      etr_mm_summary_pts.cpg</span>
<span class="sd">                      etr_mm_summary_pts.dbf</span>
<span class="sd">                      etr_mm_summary_pts.prj</span>
<span class="sd">                      etr_mm_summary_pts.shp</span>
<span class="sd">                      etr_mm_summary_pts.shx</span>
<span class="sd">                      gridMET_stats.csv</span>
<span class="sd">                      residual_plots</span>
<span class="sd">                          annual_res.html</span>
<span class="sd">                 grid.cpg</span>
<span class="sd">                 grid.dbf</span>
<span class="sd">                 grid.prj</span>
<span class="sd">                 grid.shp</span>
<span class="sd">                 grid.shx</span>
<span class="sd">            </span>
<span class="sd">        Specifically, the interpolated raster is saved to::</span>
<span class="sd">        </span>
<span class="sd">            &#39;monthly_ratios/spatial/etr_mm_invdist_400m/s20_p1/Annual_mean.tiff&#39;</span>
<span class="sd">            </span>
<span class="sd">        where the file name and directory is based on the variable being </span>
<span class="sd">        interpolated, methods, and the raster resolution. The ``out`` </span>
<span class="sd">        keyword argument lets us add any number of subdirectories to the final </span>
<span class="sd">        output directory, in this case the &#39;s20_p1&#39; dir contains info on params.  </span>
<span class="sd">        In this case the original gridMET resolution is 4 km therefore the </span>
<span class="sd">        scale facter of 0.1 results in a 400 m resolution. </span>
<span class="sd">        </span>
<span class="sd">        The final result will be the creation of the CSV::</span>
<span class="sd">            </span>
<span class="sd">            &#39;monthly_ratios/spatial/etr_mm_invdist_400m/s20_p1/gridMET_stats.csv&#39;</span>
<span class="sd">            </span>
<span class="sd">        In &quot;gridMET_stats.csv&quot; the zonal mean for ratios of annual station to </span>
<span class="sd">        gridMET ETr will be stored along with gridMET IDs, e.g.</span>
<span class="sd">        </span>
<span class="sd">            ==========  =================</span>
<span class="sd">            GRIDMET_ID  Annual_mean</span>
<span class="sd">            ==========  =================</span>
<span class="sd">            515902      0.87439453125</span>
<span class="sd">            514516      0.888170013427734</span>
<span class="sd">            513130      0.90002197265625</span>
<span class="sd">            ...         ...</span>
<span class="sd">            ==========  =================      </span>
<span class="sd">            </span>
<span class="sd">        To calculate zonal statistics of bias ratios that are not part of </span>
<span class="sd">        the default or command line workflow we can assign any numeric layer</span>
<span class="sd">        in the input summary CSV to be interpolations. For example if </span>
<span class="sd">        we wanted to interpolate the coefficient of variation of the growing</span>
<span class="sd">        season bias ratio &quot;April_to_oct_cv&quot;, then we could </span>
<span class="sd">        estimate the surface of this variable straightforwardly,</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; layer = &#39;April_to_oct_cv&#39;</span>
<span class="sd">        &gt;&gt;&gt; func = &#39;invdistnn&#39;</span>
<span class="sd">        &gt;&gt;&gt; # we can also &#39;upscale&#39; the interpolation resolution</span>
<span class="sd">        &gt;&gt;&gt; interpolate(summary_file, layer=layer, scale_factor=2, </span>
<span class="sd">        &gt;&gt;&gt;     function=func, buffer=buffer)</span>
<span class="sd">                    </span>
<span class="sd">        This will create the GeoTIFF raster::</span>
<span class="sd">        </span>
<span class="sd">            &#39;monthly_ratios/spatial/etr_mm_invdistnn_400m/April_to_oct_cv.tiff&#39;</span>
<span class="sd">               </span>
<span class="sd">        And the zonal means will be added as a column named &quot;April_to_oct_cv&quot;</span>
<span class="sd">        to:: </span>
<span class="sd">        </span>
<span class="sd">            &#39;monthly_ratios/spatial/etr_mm_invdistnn_400m/gridMET_stats.csv&#39;</span>

<span class="sd">        As with other components of ``gridwxcomp``, any other climatic</span>
<span class="sd">        variables that exist in the gridMET dataset can be used along</span>
<span class="sd">        with any corresponding station time series data from the user.</span>
<span class="sd">        The input (``in_path``) to all routines in :mod:`gridwxcomp.spatial` </span>
<span class="sd">        is the summary CSV created by :func:`gridwxcomp.calc_bias_ratios`, the </span>
<span class="sd">        prefix to this file is what determines the climatic variable </span>
<span class="sd">        that spatial analysis is conducted. See :func:`gridwxcomp.calc_bias_ratios` </span>
<span class="sd">        for examples of how to use different climatic variables, e.g. </span>
<span class="sd">        TMax or ETo.</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: if the input summary CSV file or the </span>
<span class="sd">            fishnet for extracting zonal statistics do not exist.</span>
<span class="sd">            The fishnet should be in the subdirectory of ``in_path``</span>
<span class="sd">            i.e. &quot;&lt;in_path&gt;/spatial/grid.shp&quot;.</span>
<span class="sd">    Note:</span>
<span class="sd">        This function can be used independently of :func:`make_grid`</span>
<span class="sd">        however, if the buffer and input [var]_summary_comp_[years].csv files </span>
<span class="sd">        arguments differ from those used for :func:`interpolate` the </span>
<span class="sd">        raster may not fully cover the fishnet which may result in </span>
<span class="sd">        gaps in the zonal statistics.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># avoid circular import for InterpGdal for gdal interpolation methods</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">gridwxcomp.interpgdal</span> <span class="k">import</span> <span class="n">InterpGdal</span>
    <span class="k">except</span><span class="p">:</span> <span class="c1"># for use as script, i.e. $ python spatial ...</span>
        <span class="kn">from</span> <span class="nn">interpgdal</span> <span class="k">import</span> <span class="n">InterpGdal</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">in_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;Input summary CSV file given&#39;</span><span class="o">+</span>\
                                <span class="s1">&#39; was invalid or not found&#39;</span><span class="p">)</span>
    
    <span class="c1"># look for packaged gridmet_cell_data.csv if path not given</span>
    <span class="n">gridmet_meta_path</span> <span class="o">=</span> <span class="n">get_gridmet_meta_csv</span><span class="p">(</span>
            <span class="n">gridmet_meta_path</span><span class="o">=</span><span class="n">gridmet_meta_path</span><span class="p">)</span>

    <span class="c1"># calc raster resolution in meters (as frac of 4 km)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">scale_factor</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="c1"># path to save raster of interpolated grid scaled by scale_factor</span>
    <span class="n">path_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># get variable name from input file prefix</span>
    <span class="n">grid_var</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_summary&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span><span class="p">:</span> 
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">OPJ</span><span class="p">(</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span> 
                      <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid_var</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">OPJ</span><span class="p">(</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid_var</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">res</span><span class="p">),</span>
                      <span class="n">out</span><span class="p">)</span>
        
    <span class="c1"># create output directory if does not exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">out_dir</span><span class="p">),</span> 
            <span class="s1">&#39; does not exist, creating directory.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">_run_rbf_interpolation</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">smooth</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Workflow for running scipy Rbf interpolation of scatter points&quot;&quot;&quot;</span>
        <span class="c1"># if running scipy methods prepend root dir to out path</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">OPJ</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">out_dir</span><span class="p">),</span>
                <span class="s1">&#39; does not exist, creating directory.</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">out_file</span> <span class="o">=</span> <span class="n">OPJ</span><span class="p">(</span>
            <span class="n">out_dir</span><span class="p">,</span> 
            <span class="s1">&#39;</span><span class="si">{time_agg}</span><span class="s1">.tiff&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_agg</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Interpolating </span><span class="si">{g}</span><span class="s1"> point bias ratios for: </span><span class="si">{t}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span>\
                <span class="nb">format</span><span class="p">(</span><span class="n">g</span><span class="o">=</span><span class="n">grid_var</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">layer</span><span class="p">),</span>
            <span class="s1">&#39;Using the &quot;</span><span class="si">{}</span><span class="s1">&quot; method</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function</span><span class="p">),</span>
            <span class="s1">&#39;Resolution (pixel size) of output raster: </span><span class="si">{}</span><span class="s1"> m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>            
            <span class="s1">&#39;GeoTIFF raster will be saved to: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># get grid extent based on station locations in CSV</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bounds</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">get_subgrid_bounds</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span> 
        <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">bounds</span>
        <span class="c1"># check if layer is in summary CSV </span>
        <span class="n">existing_layers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">existing_layers</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Column </span><span class="si">{}</span><span class="s1"> does not exist in input CSV:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
               <span class="n">layer</span><span class="p">,</span> <span class="n">in_path</span><span class="p">),</span>
                 <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Skipping interpolation.&#39;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># get point station data from summary CSV</span>
        <span class="n">in_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">999</span><span class="p">])</span>
        <span class="n">lon_pts</span><span class="p">,</span> <span class="n">lat_pts</span> <span class="o">=</span> <span class="n">in_df</span><span class="o">.</span><span class="n">STATION_LON</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">in_df</span><span class="o">.</span><span class="n">STATION_LAT</span><span class="o">.</span><span class="n">values</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">in_df</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    
        <span class="c1"># mask out stations with missing data</span>
        <span class="k">if</span> <span class="n">in_df</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">in_df</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
            <span class="n">n_missing</span> <span class="o">=</span> <span class="n">in_df</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="c1"># if one point or less data points exists exit</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_missing</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing sufficient bias ratios for variable: </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span>\
                        <span class="nb">format</span><span class="p">(</span><span class="n">grid_var</span><span class="p">,</span> <span class="n">layer</span><span class="p">),</span>
                        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Need at least two stations with data, skipping.&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Data missing for </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> stations for variable: </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">n_missing</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">grid_var</span><span class="p">,</span> <span class="n">layer</span><span class="p">),</span>
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">proceeding with interpolation.&#39;</span><span class="p">)</span>
            <span class="c1"># get locations where ratio is not nan</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">lon_pts</span> <span class="o">=</span> <span class="n">lon_pts</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">lat_pts</span> <span class="o">=</span> <span class="n">lat_pts</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="n">nx_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">lon_min</span> <span class="o">-</span> <span class="n">lon_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">CELL_SIZE</span><span class="p">)))</span>
        <span class="n">ny_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">lat_min</span> <span class="o">-</span> <span class="n">lat_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">CELL_SIZE</span><span class="p">)))</span>
        <span class="c1"># rbf requires uniform grid (n X n) so </span>
        <span class="c1"># extend short dimension and clip later </span>
        <span class="n">nx_cells_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nx_cells</span><span class="p">)</span>
        <span class="n">ny_cells_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ny_cells</span><span class="p">)</span>
        <span class="c1"># gdal requires &quot;upper left&quot; corner coordinates</span>
        <span class="n">lat_max_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">lat_max</span><span class="p">)</span>
        <span class="n">lon_max_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">lon_max</span><span class="p">)</span>
        <span class="c1"># extend short dimension to make square grid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nx_cells</span> <span class="o">==</span> <span class="n">ny_cells</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nx_cells</span> <span class="o">-</span> <span class="n">ny_cells</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nx_cells</span> <span class="o">&gt;</span> <span class="n">ny_cells</span><span class="p">:</span>
                <span class="n">lat_max</span> <span class="o">+=</span> <span class="n">diff</span> <span class="o">*</span> <span class="n">CELL_SIZE</span>
                <span class="n">ny_cells</span> <span class="o">+=</span> <span class="n">diff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lon_max</span> <span class="o">+=</span> <span class="n">diff</span> <span class="o">*</span> <span class="n">CELL_SIZE</span>
                <span class="n">nx_cells</span> <span class="o">+=</span> <span class="n">diff</span>

        <span class="c1"># make finer/coarse grid by scale factor</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> 
                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">nx_cells</span><span class="o">/</span><span class="n">scale_factor</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">,</span> 
                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ny_cells</span><span class="o">/</span><span class="n">scale_factor</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># extent for original created by spatial.build_subgrid</span>
        <span class="c1"># add one to make sure raster covers full extent</span>
        <span class="n">lons_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max_out</span><span class="p">,</span> 
                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">nx_cells_out</span><span class="o">/</span><span class="n">scale_factor</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lats_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max_out</span><span class="p">,</span> 
                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ny_cells_out</span><span class="o">/</span><span class="n">scale_factor</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># if function was &#39;linear_rbf&#39; </span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_rbf&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># make sampling square grid</span>
        <span class="n">XI</span><span class="p">,</span> <span class="n">YI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)</span>
        <span class="c1"># apply rbf interpolation</span>
        <span class="n">rbf</span> <span class="o">=</span> <span class="n">Rbf</span><span class="p">(</span><span class="n">lon_pts</span><span class="p">,</span> <span class="n">lat_pts</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>
        <span class="n">ZI</span> <span class="o">=</span> <span class="n">rbf</span><span class="p">(</span><span class="n">XI</span><span class="p">,</span> <span class="n">YI</span><span class="p">)</span>
        <span class="c1"># clip to original extent, rbf array flips axes, and row order... </span>
        <span class="n">ZI_out</span> <span class="o">=</span> <span class="n">ZI</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">lats_out</span><span class="p">),</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">lons_out</span><span class="p">)]</span>
        <span class="n">ZI_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">ZI_out</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#### save scipy interpolated data as raster </span>
        <span class="n">pixel_size</span> <span class="o">=</span> <span class="n">CELL_SIZE</span> <span class="o">*</span> <span class="n">scale_factor</span>
        <span class="c1"># number of pixels in each direction</span>
        <span class="n">x_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons_out</span><span class="p">)</span>
        <span class="n">y_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lats_out</span><span class="p">)</span>
        <span class="c1"># set geotransform info</span>
        <span class="n">gt</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">lon_min</span><span class="p">,</span>
                <span class="n">pixel_size</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">lat_max_out</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="o">-</span><span class="n">pixel_size</span>
        <span class="p">]</span>
        <span class="c1"># make geotiff raster</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s1">&#39;GTiff&#39;</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
            <span class="n">out_file</span><span class="p">,</span>
            <span class="n">x_size</span><span class="p">,</span> 
            <span class="n">y_size</span><span class="p">,</span> 
            <span class="mi">1</span><span class="p">,</span> 
            <span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float32</span><span class="p">,</span> 
        <span class="p">)</span>
        <span class="c1"># set projection geographic lat/lon WGS 84</span>
        <span class="n">srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
        <span class="n">srs</span><span class="o">.</span><span class="n">ImportFromEPSG</span><span class="p">(</span><span class="mi">4326</span><span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">srs</span><span class="o">.</span><span class="n">ExportToWkt</span><span class="p">())</span>
        <span class="c1"># assign spatial dimensions </span>
        <span class="n">ds</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span>
        <span class="n">outband</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># save rbf interpolated array as geotiff raster close</span>
        <span class="n">outband</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">ZI_out</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># calc residuals add to shapefile and in_path CSV, move shape to out_dir</span>
        <span class="n">calc_pt_error</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">grid_var</span><span class="p">)</span>
        <span class="c1"># calculate zonal statistics save means for each gridMET cell</span>
        <span class="k">if</span> <span class="n">zonal_stats</span><span class="p">:</span>
            <span class="n">gridmet_zonal_stats</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>
            
        <span class="c1"># plot layer&#39;s interpolated residuals as bar plot witheach Wx station           </span>
        <span class="k">if</span> <span class="n">res_plot</span><span class="p">:</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">InterpGdal</span><span class="o">.</span><span class="n">var_residual_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">layer</span><span class="p">,</span> 
                <span class="n">layer</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="s1">&#39;residual (interpolated minus station value)&#39;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;layer: </span><span class="si">{}</span><span class="s1"> algorithm: </span><span class="si">{}</span><span class="s1"> (RBF) resolution: </span><span class="si">{}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">layer</span><span class="p">,</span> <span class="n">function</span> <span class="p">,</span><span class="n">res</span><span class="p">)</span>
            <span class="n">res_plot_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span><span class="o">/</span><span class="s1">&#39;residual_plots&#39;</span>
            <span class="n">subtitle</span><span class="o">=</span><span class="s1">&#39;parameters: smooth=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">smooth</span><span class="p">)</span>
            <span class="n">source_file</span> <span class="o">=</span>  <span class="n">Path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span><span class="o">/</span><span class="n">Path</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

            <span class="n">station_bar_plot</span><span class="p">(</span><span class="n">source_file</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="n">res_plot_dir</span><span class="p">,</span> 
                <span class="n">y_label</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="n">subtitle</span><span class="p">)</span>

        
    <span class="c1"># run gdal_grid interpolation </span>
    <span class="k">if</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">InterpGdal</span><span class="o">.</span><span class="n">interp_methods</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bounds</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">get_subgrid_bounds</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">)</span> 
        <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">bounds</span>
        <span class="n">gg</span> <span class="o">=</span> <span class="n">InterpGdal</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span>
        <span class="n">gg</span><span class="o">.</span><span class="n">gdal_grid</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">interp_meth</span><span class="o">=</span><span class="n">function</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="n">scale_factor</span><span class="p">,</span>
                    <span class="n">zonal_stats</span><span class="o">=</span><span class="n">zonal_stats</span><span class="p">,</span> <span class="n">res_plot</span><span class="o">=</span><span class="n">res_plot</span><span class="p">,</span> 
                    <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        
    <span class="c1"># scipy radial basis function interpolation for now</span>
    <span class="c1"># run interpolation and zonal statistics depending on layer kwarg</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span> <span class="c1"># potential for multiprocessing</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">InterpGdal</span><span class="o">.</span><span class="n">default_layers</span><span class="p">:</span>
                <span class="n">_run_rbf_interpolation</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">smooth</span><span class="p">)</span>
        <span class="c1"># single layer option</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">_run_rbf_interpolation</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">smooth</span><span class="p">)</span>
        <span class="c1"># run select list or tuple of layers</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">:</span>
                <span class="n">_run_rbf_interpolation</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">smooth</span><span class="p">)</span></div>

<div class="viewcode-block" id="calc_pt_error"><a class="viewcode-back" href="../../api.html#gridwxcomp.spatial.calc_pt_error">[docs]</a><span class="k">def</span> <span class="nf">calc_pt_error</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">grid_var</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate point ratio estimates from interpolated raster, residuals,</span>
<span class="sd">    and add to output summary CSV and point shapefile. Make copies of</span>
<span class="sd">    updated files and saves to directory with interpolated rasters.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        in_path (str): path to comprehensive summary CSV created by </span>
<span class="sd">            :mod:`gridwxcomp.calc_bias_ratios`</span>
<span class="sd">        out_dir (str): path to dir that contains interpolated raster</span>
<span class="sd">        layer (str): layer to calculate error e.g. &quot;annual_mean&quot;</span>
<span class="sd">        grid_var (str): name of gridMET variable e.g. &quot;etr_mm&quot;</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    Note:</span>
<span class="sd">        This function should be run **after** :func:`make_points_file`</span>
<span class="sd">        because it copies data from the shapefile it created.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raster</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span><span class="o">/</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.tiff&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
    <span class="n">pt_shp</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_summary_pts.shp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid_var</span><span class="p">)</span>
    <span class="n">pt_shp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;spatial&#39;</span><span class="o">/</span><span class="n">pt_shp</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">pt_shp</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="n">make_points_file</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span>

    <span class="n">pt_shp_out</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span><span class="o">/</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_summary_pts.shp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid_var</span><span class="p">))</span>
    <span class="c1"># mean fields in point shapefile does not include &#39;_mean&#39;</span>
    <span class="n">pt_layer</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pt_layer</span> <span class="o">==</span> <span class="s1">&#39;growseason&#39;</span><span class="p">:</span>
        <span class="n">pt_layer</span> <span class="o">=</span> <span class="s1">&#39;grow&#39;</span>
    <span class="c1"># names of new fields for estimated and residual e.g. Jan_est, Jan_res</span>
    <span class="n">pt_est</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_est&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pt_layer</span><span class="p">)</span>
    <span class="n">pt_res</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_res&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pt_layer</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Extracting interpolated data at station locations and </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;calculating residuals for layer:&#39;</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
    <span class="n">pt_err</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">pt_est</span><span class="p">,</span> <span class="n">pt_res</span><span class="p">])</span>
    <span class="c1"># read raster for layer and get interpolated data for each point</span>
    <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pt_shp</span><span class="p">)</span> <span class="k">as</span> <span class="n">shp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">shp</span><span class="p">:</span>
            <span class="n">STATION_ID</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;STATION_ID&#39;</span><span class="p">]</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">]</span>
            <span class="c1"># Read pixel value at the given coordinates using Rasterio</span>
            <span class="c1"># sample() returns an iterable of ndarrays.</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">sample</span><span class="p">([</span><span class="n">coords</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># store interpolated point estimates of ratios </span>
            <span class="n">pt_err</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">STATION_ID</span><span class="p">,</span> <span class="n">pt_est</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># merge estimated point data with observed to calc residual</span>
    <span class="n">pt_err</span><span class="p">[</span><span class="s1">&#39;STATION_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt_err</span><span class="o">.</span><span class="n">index</span>
    <span class="c1"># read summary CSV with observed ratios</span>
    <span class="n">in_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;STATION_ID&#39;</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">999</span><span class="p">])</span>
    <span class="n">in_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_err</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pt_est</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt_err</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pt_est</span><span class="p">]</span>
    <span class="c1"># calculate residual estimated minus observed</span>
    <span class="n">in_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">pt_res</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">pt_est</span><span class="p">]</span> <span class="o">-</span> <span class="n">in_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">layer</span><span class="p">]</span>
    <span class="c1"># save/overwrite error to input CSV for future interpolation </span>
    <span class="n">in_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=-</span><span class="mi">999</span><span class="p">)</span>

    <span class="c1"># save copy of CSV with updated error info to out_dir with rasters</span>
    <span class="n">out_summary_csv</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span><span class="o">/</span><span class="n">Path</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">out_summary_csv</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="n">in_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">out_summary_csv</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=-</span><span class="mi">999</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">out_summary_csv</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;STATION_ID&#39;</span><span class="p">)</span>
        <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_err</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pt_est</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt_err</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pt_est</span><span class="p">]</span>
        <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_err</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pt_res</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_err</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pt_res</span><span class="p">]</span>
        <span class="n">out_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_summary_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=-</span><span class="mi">999</span><span class="p">)</span>
    
    <span class="c1"># error info to new point shapefile in raster directory</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">pt_shp_out</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pt_shp</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inf</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">inf</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">input_crs</span> <span class="o">=</span> <span class="n">inf</span><span class="o">.</span><span class="n">crs</span>
            <span class="c1"># add attributes for point estimate and residual to output points</span>
            <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="n">pt_est</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span>
            <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="n">pt_res</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span>
            <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pt_shp_out</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;ESRI Shapefile&#39;</span><span class="p">,</span> 
                    <span class="n">schema</span><span class="p">,</span> <span class="n">input_crs</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">inf</span><span class="p">:</span>
                    <span class="n">STATION_ID</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;STATION_ID&#39;</span><span class="p">]</span>
                    <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="n">pt_est</span><span class="p">]</span> <span class="o">=</span>\
                            <span class="n">in_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">STATION_ID</span><span class="p">,</span> <span class="n">pt_est</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="n">pt_res</span><span class="p">]</span> <span class="o">=</span>\
                            <span class="n">in_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">STATION_ID</span><span class="p">,</span> <span class="n">pt_res</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
    <span class="c1"># if already exists update point shapefile</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmp_out</span> <span class="o">=</span> <span class="n">pt_shp_out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.shp&#39;</span><span class="p">,</span> <span class="s1">&#39;_tmp.shp&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pt_shp_out</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inf</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">inf</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">input_crs</span> <span class="o">=</span> <span class="n">inf</span><span class="o">.</span><span class="n">crs</span>
            <span class="c1"># add attributes for point estimate and residual to output points</span>
            <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="n">pt_est</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span>
            <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="n">pt_res</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span>
            <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tmp_out</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;ESRI Shapefile&#39;</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">input_crs</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">inf</span><span class="p">:</span>
                    <span class="n">STATION_ID</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;STATION_ID&#39;</span><span class="p">]</span>
                    <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="n">pt_est</span><span class="p">]</span> <span class="o">=</span>\
                            <span class="n">in_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">STATION_ID</span><span class="p">,</span> <span class="n">pt_est</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="n">pt_res</span><span class="p">]</span> <span class="o">=</span>\
                            <span class="n">in_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">STATION_ID</span><span class="p">,</span> <span class="n">pt_res</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
        <span class="c1"># keep tmp point file with new data and remove old version</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;_tmp.&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">move</span><span class="p">(</span><span class="n">OPJ</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">OPJ</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_tmp&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>

    <span class="c1"># remove point shapefile from &quot;spatial&quot; directory and tmp files</span>
    <span class="n">spatial_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;spatial&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">spatial_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_summary_pts&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid_var</span><span class="p">):</span>
            <span class="c1"># delete temp point shapefile</span>
            <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;spatial&#39;</span><span class="o">/</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

    <span class="c1"># delete tmp summary csv used in interpgdal _make_pt_vrt method </span>
    <span class="n">tmp_csv</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="s1">&#39;_tmp.csv&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmp_csv</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">tmp_csv</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>


<div class="viewcode-block" id="gridmet_zonal_stats"><a class="viewcode-back" href="../../api.html#gridwxcomp.spatial.gridmet_zonal_stats">[docs]</a><span class="k">def</span> <span class="nf">gridmet_zonal_stats</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">raster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate zonal means from interpolated surface of etr bias ratios</span>
<span class="sd">    created by :func:`interpolate` using the fishnet grid created by </span>
<span class="sd">    :func:`make_grid`. Save mean values for each gridMET cell to</span>
<span class="sd">    a CSV file joined to gridMET IDs. </span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        in_path (str): path to [var]_summary_comp_[years].csv file containing </span>
<span class="sd">            monthly bias ratios, lat, long, and other data. Created by </span>
<span class="sd">            :mod:`gridwxcomp.calc_bias_ratios`. </span>
<span class="sd">        raster (str): path to interpolated raster of bias ratios to</span>
<span class="sd">            be used for zonal stats. First created by :func:`interpolate`.</span>
<span class="sd">        </span>
<span class="sd">    Example:</span>
<span class="sd">        Although it is prefered to use this function as part of </span>
<span class="sd">        :func:`interpolate` or indirectly using the :mod:`gridwxcomp.spatial`</span>
<span class="sd">        command line usage. However if the grid shapefile and spatial</span>
<span class="sd">        interpolated raster(s) have already been created without zonal</span>
<span class="sd">        stats then,</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; from gridwxcomp import spatial</span>
<span class="sd">        &gt;&gt;&gt; # assign input paths</span>
<span class="sd">        &gt;&gt;&gt; summary_file = &#39;monthly_ratios/etr_mm_summary_comp_[years].csv&#39;  </span>
<span class="sd">        &gt;&gt;&gt; raster_file = &#39;monthly_ratios/spatial/etr_mm_invdist_400m/Jan_mean.tiff&#39;</span>
<span class="sd">        &gt;&gt;&gt; spatial.gridmet_zonal_stats(summary_file, raster_file)</span>
<span class="sd">        </span>
<span class="sd">        The final result will be the creation of::</span>
<span class="sd">            </span>
<span class="sd">            &#39;monthly_ratios/spatial/etr_mm_invdist_400m/gridMET_stats.csv&#39;</span>
<span class="sd">            </span>
<span class="sd">        The resulting CSV contains the gridMET IDS and zonal means</span>
<span class="sd">        for each gridMET cell in the fishnet which must exist at::</span>
<span class="sd">        </span>
<span class="sd">            &#39;monthly_ratios/spatial/grid.shp&#39;</span>
<span class="sd">            </span>
<span class="sd">        also see :func:`interpolate`</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: if the input summary CSV file or the </span>
<span class="sd">            fishnet for extracting zonal statistics do not exist.</span>
<span class="sd">            The fishnet should be in the subdirectory of ``in_path``</span>
<span class="sd">            at &quot;/spatial/grid.shp&quot;.</span>

<span class="sd">    Note:</span>
<span class="sd">        If zonal statistics are estimated for the same variable on the</span>
<span class="sd">        same raster more than once, the contents of that column in the </span>
<span class="sd">        gridMET_stats.csv file will be overwritten. </span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">in_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;Input summary CSV file given&#39;</span><span class="o">+</span>\
                                <span class="s1">&#39; was invalid or not found&#39;</span><span class="p">)</span>
    <span class="c1"># look for fishnet created in &#39;in_path/spatial&#39;</span>
    <span class="n">path_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># get variable names from input file prefix</span>
    <span class="n">grid_var</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_summ&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">var_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># grid is in the &quot;spatial&quot; subdir of in_path</span>
    <span class="n">grid_file</span> <span class="o">=</span> <span class="n">OPJ</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="s1">&#39;spatial&#39;</span><span class="p">,</span> <span class="s1">&#39;grid.shp&#39;</span><span class="p">)</span>
    <span class="c1"># save zonal stats to summary CSV in same dir as raster as of version 0.3</span>
    <span class="n">raster_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">raster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="n">OPJ</span><span class="p">(</span><span class="n">raster_root</span><span class="p">,</span> <span class="s1">&#39;gridMET_stats.csv&#39;</span><span class="p">)</span>

    <span class="c1"># this error would only occur when using within Python </span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">grid_file</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">grid_file</span><span class="p">),</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">does not exist, create it using spatial.make_grid first&#39;</span>
        <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s1">&#39;Calculating&#39;</span><span class="p">,</span> <span class="n">grid_var</span><span class="p">,</span> <span class="s1">&#39;zonal means for&#39;</span><span class="p">,</span> <span class="n">var_name</span>
    <span class="p">)</span>

    <span class="c1"># calc zonal stats and open for grid IDs</span>
    <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">grid_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">zs</span> <span class="o">=</span> <span class="n">zonal_stats</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">raster</span><span class="p">,</span> <span class="n">all_touched</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">gridmet_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GRIDMET_ID&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">source</span><span class="p">]</span>

    <span class="c1"># get just mean values, zonal_stats can do other stats...</span>
    <span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zs</span><span class="p">]</span>
    <span class="n">out_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;GRIDMET_ID&#39;</span><span class="p">:</span> <span class="n">gridmet_ids</span><span class="p">,</span> 
            <span class="n">var_name</span><span class="p">:</span> <span class="n">means</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">out_df</span><span class="o">.</span><span class="n">GRIDMET_ID</span> <span class="o">=</span> <span class="n">out_df</span><span class="o">.</span><span class="n">GRIDMET_ID</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># drop rows for cells outside of gridMET master grid</span>
    <span class="n">out_df</span> <span class="o">=</span> <span class="n">out_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">out_df</span><span class="p">[</span><span class="n">out_df</span><span class="o">.</span><span class="n">GRIDMET_ID</span> <span class="o">==</span> <span class="o">-</span><span class="mi">999</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># save or update existing csv file</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">out_file</span><span class="p">),</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">does not exist, creating file&#39;</span>
        <span class="p">)</span>
        <span class="n">out_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># overwrite column values if exists, else append</span>
        <span class="n">existing_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
        <span class="n">existing_df</span><span class="o">.</span><span class="n">GRIDMET_ID</span> <span class="o">=</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">GRIDMET_ID</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1"># may throw error if not same size as original grid</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">existing_df</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">out_df</span><span class="p">)</span>
                <span class="n">existing_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>   
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Zonal stats for this variable already exist but they&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;appear to have been calculated with a different grid&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;overwriting existing file at:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                      <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">out_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">existing_df</span> <span class="o">=</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">out_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;GRIDMET_ID&#39;</span><span class="p">)</span>
            <span class="c1">#existing_df = pd.concat([existing_df, out_df], axis=1).drop_duplicates()</span>
            <span class="n">existing_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>   </div>
    
    
<span class="k">def</span> <span class="nf">arg_parse</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Command line usage of grdwxcomp spatial.py for creating shapefiles of </span>
<span class="sd">    climate station point data of bias ratios, build fishnet around stations,</span>
<span class="sd">    perform spatial interpolation of ratios, and extract zonal means for gridMET    </span>
<span class="sd">    cells.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="n">arg_parse</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">,</span>
        <span class="c1">#formatter_class=argparse.RawDescriptionHelpFormatter)</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">)</span>
    <span class="n">optional</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_action_groups</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="c1"># optionals listed second</span>
    <span class="n">required</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;required arguments&#39;</span><span class="p">)</span>
    <span class="n">required</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--input&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;PATH&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Input summary_comp CSV file of climate/gridMET bias ratios &#39;</span><span class="o">+</span>\
             <span class="s1">&#39;created by first running calc_bias_ratios.py&#39;</span><span class="p">)</span>
    <span class="n">optional</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;--layer&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Layer(s) to perform spatial interpolation in input summary &#39;</span><span class="o">+</span>\
             <span class="s1">&#39;CSV, if multiple use comma separation e.g. Jan_mean,Aug_mean&#39;</span><span class="p">)</span>
    <span class="n">optional</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--out-dir&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;PATH&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Subdirectory to save interpolated rasters&#39;</span><span class="p">)</span>
    <span class="n">optional</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;--buffer&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of gridMET cells to expand outer bounds of fishnet &#39;</span><span class="o">+</span>\
             <span class="s1">&#39;which can be used for extrapolation&#39;</span><span class="p">)</span>
    <span class="n">optional</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--scale&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Scale facter used on gridMET resolution to down/upscale &#39;</span><span class="o">+</span>\
             <span class="s1">&#39;interpolation output which is applied to the gridMET cell &#39;</span><span class="o">+</span>\
             <span class="s1">&#39;size of 4 km, default 400 m&#39;</span><span class="p">)</span>
    <span class="n">optional</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--function&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;invdist&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Function to use for spatial interpolation, gdal&#39;</span><span class="o">+</span>\
                <span class="s1">&#39; methods include invdist, invdistnn, average, nearest,&#39;</span><span class="o">+</span>\
                <span class="s1">&#39; and linear. Radial basis functions include: multiquadric,&#39;</span><span class="o">+</span>\
                <span class="s1">&#39; inverse, gaussian, linear_rbf, cubic, quintic, thin_plate&#39;</span><span class="p">)</span> 
    <span class="n">optional</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--smooth&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Smooth parameter for radial basis func interpolation methods&#39;</span><span class="p">)</span>
    <span class="n">optional</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--params&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Parameter string e.g. &quot;:power=2:smoothing=.1:nodata=-999&quot; for&#39;</span><span class="o">+</span>\
            <span class="s1">&#39; gdal_grid spatial interpolation methods&#39;</span><span class="p">)</span>
    <span class="n">optional</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;-z&#39;</span><span class="p">,</span> <span class="s1">&#39;--zonal-stats&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Flag to NOT extract zonal means of&#39;</span><span class="o">+</span>\
            <span class="s1">&#39; interpolated rasters to gridMET cells&#39;</span><span class="p">)</span>
    <span class="n">optional</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--overwrite-grid&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Flag to overwrite existing fishnet grid&#39;</span><span class="p">)</span>
    <span class="n">optional</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;--no-resid-plot&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Flag to NOT generate residual plot&#39;</span><span class="o">+</span>\
            <span class="s1">&#39; between observed and interpolated station values&#39;</span><span class="p">)</span>    
    <span class="n">optional</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--options&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Additional command line options for gdal_grid interpolation&#39;</span><span class="p">)</span>
    <span class="n">optional</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;-g&#39;</span><span class="p">,</span> <span class="s1">&#39;--gridmet-meta&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;GridMET metadata CSV file with cell data, packaged with &#39;</span><span class="o">+</span>\
             <span class="s1">&#39;gridwxcomp and automatically found if pip was used to install &#39;</span><span class="o">+</span>\
             <span class="s1">&#39;if not given it needs to be located in the currect directory&#39;</span><span class="p">)</span>
<span class="c1">#    optional.add_argument(</span>
<span class="c1">#        &#39;--debug&#39;, default=logging.INFO, const=logging.DEBUG,</span>
<span class="c1">#        help=&#39;Debug level logging&#39;, action=&quot;store_const&quot;, dest=&quot;loglevel&quot;)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">_action_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optional</span><span class="p">)</span><span class="c1"># to avoid optionals listed first</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">args</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">arg_parse</span><span class="p">()</span>
        
    <span class="c1"># parse layers if multiple</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">layer</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># get single layer as string</span>
        
    <span class="n">main</span><span class="p">(</span>
        <span class="n">input_file_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
        <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span>
        <span class="n">out</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span>
        <span class="n">buffer</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span>
        <span class="n">scale_factor</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
        <span class="n">function</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">function</span><span class="p">,</span>
        <span class="n">smooth</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">smooth</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
        <span class="n">zonal_stats</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">no_zonal_stats</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">overwrite_grid</span><span class="p">,</span>
        <span class="n">res_plot</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">no_resid_plot</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
        <span class="n">gridmet_meta_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">gridmet_meta</span>
    <span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, John Volk and Chris Pearson

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXX-1', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>